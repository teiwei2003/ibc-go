# ADR 026:IBC 客户端恢复机制

## 变更日志

- 2020/06/23:初始版本
- 2020/08/06:每次审查和参考版本的修订
- 2021/01/15:修改以支持替代客户端解冻
- 2021/05/20:修改以简化共识状态复制，移除初始高度

## 地位

*公认*

## 语境

### 概括

在发布时，IBC 将是一个新颖的协议，没有经验丰富的用户群。在协议层，无法区分由于真正错误(拜占庭行为)导致的客户端到期或不当行为和由于用户错误(未能更新客户端或意外双重签名)导致的客户端到期或不当行为。在基础 IBC 协议和 ICS 20 可替代代币转移实现中，如果客户端无法再更新，则该通道中的资金将被永久锁定且无法再转移。就这样做的安全性而言，最好为用户提供可在这些特殊情况下使用的恢复机制。

### 特殊情况

关注的状态是与连接和通道关联的客户端无法再更新。发生这种情况的原因有多种:

1. 客户端跟随的链已经停止并且不再产生块/头，因此无法对客户端进行更新
1. 客户端跟随的链继续运行，但在解绑期内没有中继者提交新的头部，客户端已过期
    1. 这可能是由于真正的不当行为(故意的拜占庭行为)或仅仅是验证者的错误，但客户端无法区分这两种情况
1. 客户端关注的链出现异常事件，客户端被冻结无法更新

### 安全模型

三分之二的验证器集(治理的法定人数、模块参与)已经可以对任意数据进行签名，因此允许治理在延迟期后手动强制使用新标头更新客户端不会显着改变安全模型。

## 决定

我们选择不处理实际上已经停止的链，这必然是拜占庭行为，在这种情况下，无论如何都不太可能恢复令牌(传输中的数据包不能超时，但其相对影响很小)。

1. 需要使用以下附加标志创建 Tendermint 轻客户端 (ICS 07)
    1.`allow_governance_override_after_expiry`(布尔值，默认为false)
1. 要求 Tendermint 轻客户端(ICS 07)暴露以下额外的内部查询功能
    1. `Expired() boolean`，返回客户端自上次更新以来是否已经过了信任期(在这种情况下无法验证头)
1. 需要使用以下附加标志创建 Tendermint 轻客户端 (ICS 07) 和单机客户端 (ICS 06)
    1.`allow_governance_override_after_misbehaviour`(布尔值，默认为false)
1. 要求 Tendermint 轻客户端(ICS 07)暴露以下额外的状态突变函数
    1. `Unfreeze()`，它在行为不当后解冻轻客户端并清除之前设置的任何冻结高度
1.在`x/ibc`模块中添加新的治理提案类型`ClientUpdateProposal`
    1. 使用两个客户端标识符(`string`)扩展基础`Proposal`。
    1. 第一个客户端标识符是建议的要更新的客户端。此客户端必须已冻结或已过期。
    1. 第二个客户是替代客户。它携带可能更新的客户端的所有状态。它必须具有与可能更新的客户端相同的客户端和链参数(最新高度、冻结高度和链 ID 除外)。它应该在投票期间不断更新。
    1. 如果此治理提案通过，则试用客户端将更新为替代者的最新状态，当且仅当:
        1. `allow_governance_override_after_expiry` 为真且客户端已过期(`Expired()` 返回真)
        1. `allow_governance_override_after_misbehaviour` 为真，客户端已被冻结(`Frozen()` 返回真)
            1.在这种情况下，另外，通过调用`Unfreeze()`来解冻客户端


请注意，由于不当行为而被冻结的客户端必须等待证据到期以避免再次冻结。

此 ADR 不涉及计划升级，这些升级按照 [规范](https://github.com/cosmos/ibc/tree/master/spec/client/ics-007-tendermint-client#upgrades) 单独处理。

## 结果

### 积极的

- 建立客户到期恢复机制
- 建立在行为不当的情况下进行客户恢复的机制
- 如果客户不希望允许它，可以选择禁止这种恢复机制
- 构建 ClientUpdate 提案与创建新客户端一样困难

### 消极的

- 用户必须理解客户端创建的额外复杂性
- 替代者的应对状态增加了复杂性
- 治理参与者必须对替代客户进行投票

### 中性的

没有中立的后果。

## 参考

- [事先讨论](https://github.com/cosmos/ics/issues/421)
- [时代号讨论](https://github.com/cosmos/ics/issues/439)
- [升级方案讨论](https://github.com/cosmos/ics/issues/445) 