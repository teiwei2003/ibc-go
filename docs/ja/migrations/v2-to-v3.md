# ibc-gov2からv3への移行

このドキュメントは、CHANGELOGに示されているよりも多くの情報を必要とする可能性のある重要な変更を強調することを目的としています。
ibc-goのユーザーが行う必要のある変更は、ここに文書化する必要があります。

このドキュメントの4つの潜在的なユーザーグループに基づいて、4つのセクションがあります。
-チェーン
-IBCアプリ
-中継器
-IBCライトクライアント

**注:** ibc-goはgolangセマンティックバージョニングをサポートしているため、メジャーリリースでバージョン番号を上げるには、すべてのインポートを更新する必要があります。
```go
github.com/cosmos/ibc-go/v2 -> github.com/cosmos/ibc-go/v3
```

ibc-goのv1またはv2からアップグレードする場合、ジェネシスやインプレース移行は必要ありません。

## チェーン

ICS27チェーン間アカウントがibc-goのサポートされているIBCアプリケーションとして追加されました。
詳細については、[ICS27ドキュメント](../app_modules/interchain-accounts/overview.md)を参照してください。

## IBCアプリ


### `OnChanOpenTry`はネゴシエートされたアプリケーションバージョンを返す必要があります

`OnChanOpenTry`アプリケーションコールバックが変更されました。
戻り署名にアプリケーションのバージョンが含まれるようになりました。
IBCアプリケーションは、カウンターパーティバージョンを使用して `OnChanOpenTry`でアプリケーションバージョンネゴシエーションを実行する必要があります。
次に、ネゴシエートされたアプリケーションバージョンを `OnChanOpenTry`でコアIBCに返す必要があります。
コアIBCは、このバージョンをTRYOPENチャネルに設定します。

### `IBCModule`インターフェースから削除された` NegotiateAppVersion`

以前は、このロジックは `NegotiateAppVersion`関数によって処理されていました。
中継者は、 `ChanOpenTry`を呼び出す前にこの関数を照会します。
次に、アプリケーションは、渡されたバージョンが正しいことを確認する必要があります。
これで、アプリケーションはチャネルハンドシェイク中にこのバージョンネゴシエーションを実行するため、 `NegotiateAppVersion`は不要になります。

### チャネル状態はアプリケーションコールバックの前に設定されません

チャネルハンドシェイクロジックは、コアIBC内で再編成されました。
アプリケーションコールバックが実行された後、チャネル状態は状態に設定されません。
アプリケーションは、チャネルキーパーにチャネル状態を照会するのではなく、渡されたチャネルパラメータのみに依存する必要があります。

### IBCアプリケーションのコールバックが `AppModule`から` IBCModule`に移動しました

以前は、IBCモジュールのコールバックは `AppModule`タイプの一部でした。
推奨されるアプローチは、 `IBCModule`タイプを作成し、IBCモジュールコールバックを` AppModule`から別のファイル `ibc_module.go`の` IBCModule`に移動することです。

このリリースでは、上記の形式を適用することにより、モックモジュールのgoAPIが機能しなくなりました。
IBCモジュールのコールバックは、モックモジュールの `AppModule`から新しいタイプの` IBCModule`に移動されました。

このリリースの一部として、モックモジュールはミドルウェアテストをサポートするようになりました。詳細については、[README](../../testing/README.md#middleware-testing)を参照してください。

例として、[mock](../../tests/mock/ibc_module.go)および[transfer](../../modules/apps/transfer/ibc_module.go)モジュールを確認してください。さらに、[simapp](../../tests/simapp/app.go)は、 `AppModule`を優先して` IBCModule`タイプをIBCルーターに追加する方法の例を示しています。

## 中継器

`AppVersion`gRPCは削除されました。
`MsgChanOpenTry`の` version`文字列は非推奨になり、コアIBCによって無視されます。
中継者は、 `ChanOpenTry`ステップで使用するバージョンを決定する必要がなくなりました。
IBCアプリケーションは、カウンターパーティバージョンを使用して正しいバージョンを判別します。

## IBCライトクライアント

`GetProofSpecs`関数は` ClientState`インターフェースから削除されました。この機能は、以前はコアIBCによって使用されていませんでした。この機能を使用しないライトクライアントは、この機能を削除する場合があります。