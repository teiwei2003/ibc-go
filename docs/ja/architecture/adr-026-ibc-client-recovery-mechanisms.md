# ADR 026:IBCクライアントの回復メカニズム

## 変更ログ

-2020/06/23:初期バージョン
-2020/08/06:レビューごとの改訂と参照バージョン
--2021/01/15:フリーズ解除の代替クライアントをサポートするための改訂
-2021/05/20:コンセンサス状態のコピーを簡素化するための改訂、初期の高さの削除

## 状態

*承認済み*

## 環境

### 概要

発売時には、経験豊富なユーザーベースがなくても、IBCは新しいプロトコルになります。プロトコル層では、本物の障害(ビザンチンの動作)によるクライアントの有効期限または誤動作と、ユーザーのミス(クライアントの更新の失敗または誤った二重署名)によるクライアントの有効期限または誤動作を区別することはできません。基本IBCプロトコルおよびICS20代替可能トークン転送の実装では、クライアントを更新できなくなった場合、そのチャネルの資金は永続的にロックされ、転送できなくなります。安全に実行できる範囲で、これらの例外的な場合に利用できる回復メカニズムをユーザーに提供することが望ましいでしょう。

### 例外的なケース

問題の状態は、接続とチャネルに関連付けられているクライアントを更新できなくなった場合です。これはいくつかの理由で発生する可能性があります。

1.クライアントがフォローしているチェーンが停止し、ブロック/ヘッダーを生成しなくなったため、クライアントを更新できません。
1.クライアントがフォローしているチェーンは動作を継続していますが、ボンディング解除期間内に新しいヘッダーを送信したリレーがなく、クライアントの有効期限が切れています
    1.これは、実際の不正行為(意図的なビザンチンの行動)またはバリデーターによる単なる間違いが原因である可能性がありますが、クライアントはこれら2つのケースを区別できません。
1.クライアントがフォローしているチェーンで不正なイベントが発生し、クライアントがフリーズしたため、更新できなくなりました

###セキュリティモデル

バリデーターセットの3分の2(ガバナンスのクォーラム、モジュール参加)はすでに任意のデータに署名できるため、遅延期間後にガバナンスがクライアントを新しいヘッダーで手動で強制更新できるようにしても、セキュリティモデルは実質的に変更されません。

## 決断

実際に停止したチェーンは処理しないことを選択します。これは必然的にビザンチンの動作であり、その場合、トークンの回復はとにかく不可能である可能性があります(処理中のパケットはタイムアウトできませんが、その相対的な影響はわずかです)。

1. Tendermintライトクライアント(ICS 07)を次の追加フラグで作成する必要があります
    1. `allow_governance_override_after_expiry`(ブール値、デフォルトはfalse)
1. Tendermint lightクライアント(ICS 07)に、次の追加の内部クエリ関数を公開するように要求します
    1. `Expired()boolean`は、クライアントが最後の更新から信頼期間を経過したかどうかを返します(この場合、ヘッダーを検証できません)。
1. Tendermintライトクライアント(ICS 07)およびソロマシンクライアント(ICS 06)を次の追加フラグで作成する必要があります
    1. `allow_governance_override_after_misbehaviour`(ブール値、デフォルトはfalse)
1. Tendermintライトクライアント(ICS 07)に、次の追加の状態ミューテーション関数を公開するように要求します
    1. `Unfreeze()`は、不正行為の後にライトクライアントのフリーズを解除し、以前に設定されたフリーズされた高さをクリアします
1. `x/ibc`モジュールに新しいガバナンス提案タイプ` ClientUpdateProposal`を追加します
    1.ベースの `Proposal`を2つのクライアント識別子(` string`)で拡張します。
    1.最初のクライアントIDは、更新するように提案されたクライアントです。このクライアントは凍結されているか、期限切れになっている必要があります。
    1.2番目のクライアントは代替クライアントです。更新される可能性のあるクライアントのすべての状態を保持します。更新される可能性のあるクライアントと同一のクライアントおよびチェーンパラメーターが必要です(最新の高さ、凍結された高さ、およびチェーンIDを除く)。投票期間中は継続的に更新する必要があります。
    1.このガバナンス提案が通過した場合、次の場合に限り、試用中のクライアントは代替の最新の状態に更新されます。
        1. `allow_governance_override_after_expiry`がtrueであり、クライアントの有効期限が切れています(` Expired() `はtrueを返します)
        1. `allow_governance_override_after_misbehaviour`がtrueであり、クライアントがフリーズされています(` Frozen() `はtrueを返します)
            1.この場合、さらに、 `Unfreeze()`を呼び出すことでクライアントのフリーズを解除します


不正行為のために凍結されたクライアントは、再凍結されないように証拠の有効期限が切れるのを待つ必要があることに注意してください。

このADRは、[仕様](https://github.com/cosmos/ibc/tree/master/spec/client/ics-007-tendermint-client#upgrades)に従って個別に処理される計画されたアップグレードには対応していません。

## 結果

### ポジティブ

-有効期限が切れた場合のクライアント回復のメカニズムを確立します
-不正行為が発生した場合のクライアント回復のメカニズムを確立します
-クライアントは、この回復メカニズムを許可したくない場合は、許可しないことを選択できます
-ClientUpdateプロポーザルの作成は、新しいクライアントの作成と同じくらい困難です。

### ネガティブ

-ユーザーが理解する必要のあるクライアント作成の追加の複雑さ
-代替の対処状態は複雑さを追加します
-ガバナンス参加者は、代替クライアントに投票する必要があります

### ニュートラル

中立的な結果はありません。

## 参照

-[事前のディスカッション](https://github.com/cosmos/ics/issues/421)
-[エポック番号のディスカッション](https://github.com/cosmos/ics/issues/439)
-[アップグレード計画のディスカッション](https://github.com/cosmos/ics/issues/445)